{% extends "base.html" %}

{% block title %}Mesajlar - SKYNEX{% endblock %}

{% block content %}
<div class="messages-container">
    <!-- Mobil Sidebar Toggle Butonu -->
    <div class="mobile-sidebar-toggle" id="mobileSidebarToggle">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sol Sidebar - Kullanıcı Listesi -->
    <div class="users-sidebar" id="usersSidebar">
        <div class="sidebar-header">
            <h5>Kullanıcılar</h5>
            <button class="close-sidebar-btn" id="closeSidebarBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="users-list" id="usersList">
            <!-- Kullanıcılar buraya yüklenecek -->
        </div>
    </div>

    <!-- Sağ Taraf - Mesajlaşma Alanı -->
    <div class="chat-area">
        <div class="chat-header" id="chatHeader">
            <div class="chat-user-info">
                <img src="{{ url_for('static', filename='images/default.png') }}" alt="Profil" class="chat-user-avatar" id="chatUserAvatar">
                <div class="chat-user-details">
                    <h6 id="chatUserName">Bir kullanıcı seçin</h6>
                    <small id="chatUserRole">Mesajlaşmaya başlamak için sol taraftan bir kullanıcı seçin</small>
                </div>
            </div>
        </div>

        <div class="messages-list" id="messagesList">
            <!-- Mesajlar buraya yüklenecek -->
            <div class="no-chat-selected">
                <i class="fas fa-comments"></i>
                <p>Mesajlaşmaya başlamak için sol taraftan bir kullanıcı seçin</p>
            </div>
        </div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
            <div class="input-group" style="position:relative;">
                <button type="button" class="btn btn-light emoji-btn" tabindex="-1" style="font-size: 1.5em;">😊</button>
                <button type="button" class="btn btn-light" id="my-sticker-btn" tabindex="-1" style="font-size: 1.5em;">
                    <i class="fas fa-paperclip"></i>
                </button>
                <div class="emoji-panel" style="display:none; position:absolute; bottom:60px; left:10px; background:#fff; border:1px solid #e0e0e0; border-radius:16px; padding:12px; z-index:2000; max-width:380px; max-height:220px; overflow:auto; box-shadow:0 8px 32px rgba(0,0,0,0.18); grid-template-columns: repeat(8, 1fr); gap:8px; grid-auto-rows: 36px;">
                    <!-- Standart emojiler -->
                    <span class="emoji" style="font-size:1.5em;cursor:pointer;transition:transform .1s;">😀</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😁</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😂</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤣</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😃</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😄</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😅</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😆</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😉</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😊</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😋</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😎</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😍</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😘</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥰</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😗</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😙</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😚</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🙂</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤗</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤩</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤔</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤨</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😐</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😑</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😶</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🙄</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😏</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😣</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😥</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😮</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤐</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😯</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😪</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😫</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥱</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😴</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😌</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😛</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😜</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😝</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤤</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😒</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😓</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😔</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😕</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🙃</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤑</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😲</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">☹️</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🙁</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😖</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😞</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😟</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😤</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😢</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😭</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😦</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😧</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😨</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😩</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤯</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😬</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😰</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😱</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥵</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥶</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😳</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤪</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😵</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥴</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😠</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😡</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤬</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😷</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤒</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤕</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤢</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤮</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥳</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🥺</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤠</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😇</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤡</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤥</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤫</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤭</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🧐</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤓</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😈</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👿</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👹</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👺</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">💀</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👻</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👽</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">👾</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🤖</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😺</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😸</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😹</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😻</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😼</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😽</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">🙀</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😿</span> <span class="emoji" style="font-size:1.5em;cursor:pointer;">😾</span>
                </div>
                <input type="text" class="form-control" id="messageInput" placeholder="Mesajınızı yazın..." maxlength="1000">
                <button class="btn btn-primary" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Kendi sticker/emoji modalı -->
<div class="modal fade" id="myStickerModal" tabindex="-1" aria-labelledby="myStickerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#23272b;color:#fff;">
      <div class="modal-header">
        <h5 class="modal-title" id="myStickerModalLabel">Kendi Emojilerim & Çıkartmalarım</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="my-sticker-modal-list" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;"></div>
    </div>
  </div>
</div>

<!-- Düzenleme Modalı -->
<div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="background:#23272b;color:#fff;">
      <div class="modal-header">
        <h5 class="modal-title" id="editMessageModalLabel">Mesajı Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="editMessageInput" class="form-control" rows="3" maxlength="1000"></textarea>
        <input type="hidden" id="editMessageId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" id="saveEditBtn">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<style>
.messages-container {
    display: flex;
    height: calc(100vh - 80px);
    background-color: #1a1a1a;
    color: white;
    position: relative;
}

.mobile-sidebar-toggle {
    display: none;
    position: fixed;
    top: 90px;
    left: 10px;
    z-index: 1000;
    background-color: #8B0000;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.users-sidebar {
    width: 300px;
    background-color: #2d2d2d;
    border-right: 1px solid #444;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #444;
    background-color: #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-header h5 {
    margin: 0;
    color: white;
}

.close-sidebar-btn {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 5px;
}

.users-list {
    flex: 1;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #444;
    cursor: pointer;
    transition: background-color 0.2s;
}

.user-item:hover {
    background-color: #3d3d3d;
}

.user-item.active {
    background-color: #8B0000;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.user-name {
    font-weight: bold;
    margin-bottom: 2px;
    color: white;
}

.user-role {
    font-size: 12px;
    color: #ccc;
    margin-bottom: 5px;
}

.user-last-message {
    font-size: 12px;
    color: #999;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    background-color: #8B0000;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    margin-left: 10px;
}

.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #1a1a1a;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid #444;
    background-color: #2d2d2d;
}

.chat-user-info {
    display: flex;
    align-items: center;
}

.chat-user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.chat-user-details h6 {
    margin: 0;
    color: white;
}

.chat-user-details small {
    color: #ccc;
}

.messages-list {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: #1a1a1a;
}

.no-chat-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
}

.no-chat-selected i {
    font-size: 48px;
    margin-bottom: 20px;
}

.message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
}

.message.own {
    align-items: flex-end;
}

.message.other {
    align-items: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
}

.message.own .message-content {
    background-color: #8B0000;
    color: white;
}

.message.other .message-content {
    background-color: #333;
    color: white;
}

.message-time {
    font-size: 11px;
    color: #999;
    margin-top: 5px;
    margin-left: 10px;
}

.message-input-container {
    padding: 20px;
    background-color: #2d2d2d;
    border-top: 1px solid #444;
}

.input-group {
    display: flex;
}

.input-group input {
    background-color: #333;
    border: 1px solid #444;
    color: white;
}

.input-group input:focus {
    background-color: #333;
    border-color: #8B0000;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(139, 0, 0, 0.25);
}

.input-group .btn {
    background-color: #8B0000;
    border-color: #8B0000;
}

.input-group .btn:hover {
    background-color: #6b0000;
    border-color: #6b0000;
}

/* Scrollbar stilleri */
.users-list::-webkit-scrollbar,
.messages-list::-webkit-scrollbar {
    width: 6px;
}

.users-list::-webkit-scrollbar-track,
.messages-list::-webkit-scrollbar-track {
    background: #2d2d2d;
}

.users-list::-webkit-scrollbar-thumb,
.messages-list::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 3px;
}

.users-list::-webkit-scrollbar-thumb:hover,
.messages-list::-webkit-scrollbar-thumb:hover {
    background: #888;
}

/* Mobil Responsive */
@media (max-width: 768px) {
    .mobile-sidebar-toggle {
        display: block;
    }
    
    .close-sidebar-btn {
        display: block;
    }
    
    .users-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1001;
        transform: translateX(-100%);
    }
    
    .users-sidebar.open {
        transform: translateX(0);
    }
    
    .chat-area {
        width: 100%;
    }
    
    .message-content {
        max-width: 85%;
    }
    
    .chat-header {
        padding: 15px;
    }
    
    .messages-list {
        padding: 15px;
    }
    
    .message-input-container {
        padding: 15px;
    }
    
    /* Mobilde chat-header içindeki kullanıcı bilgilerini sağa yasla */
    .chat-user-info {
        justify-content: flex-end !important;
        flex-direction: row !important;
        text-align: right !important;
    }
    .chat-user-details {
        text-align: right !important;
    }
    
    /* Mobilde kullanıcı bilgilerini sağ tarafa taşı */
    .user-item {
        flex-direction: row-reverse;
        text-align: right;
    }
    
    .user-avatar {
        margin-right: 0;
        margin-left: 15px;
    }
    
    .user-info {
        text-align: right;
    }
    
    .unread-badge {
        margin-left: 0;
        margin-right: 10px;
    }
}

@media (max-width: 480px) {
    .user-item {
        padding: 12px 15px;
    }
    
    .user-avatar {
        width: 35px;
        height: 35px;
        margin-left: 12px;
    }
    
    .chat-user-avatar {
        width: 35px;
        height: 35px;
        margin-right: 12px;
    }
    
    .message-content {
        max-width: 90%;
        padding: 8px 12px;
    }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
let socket;
let currentChatUser = null;
let currentUserId = null;

document.addEventListener('DOMContentLoaded', function() {
    socket = io();
    
    // Current user ID'sini al
    fetch('/api/current_user')
        .then(response => response.json())
        .then(data => {
            currentUserId = data.id;
            console.log('Current user ID:', currentUserId);
        });
    
    // DM odasına katıl
    socket.emit('join_dm', {});
    
    // Kullanıcıları yükle
    loadUsers();
    
    // Event listener'ları ekle
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Mobil sidebar toggle
    document.getElementById('mobileSidebarToggle').addEventListener('click', toggleSidebar);
    document.getElementById('closeSidebarBtn').addEventListener('click', closeSidebar);
    
    // Yeni DM geldiğinde
    socket.on('new_dm', function(data) {
        console.log('Yeni DM alındı:', data);
        if (currentChatUser && (data.sender_id === currentChatUser || data.receiver_id === currentChatUser)) {
            // Mevcut sohbete yeni mesaj ekle
            const messageData = {
                id: data.id,
                content: data.content,
                timestamp: data.timestamp,
                is_own: data.sender_id === currentUserId
            };
            addMessageToChat(messageData);
        }
        // Kullanıcı listesini güncelle
        loadUsers();
    });
    
    // Bağlantı durumunu kontrol et
    socket.on('connect', function() {
        console.log('Socket.io bağlandı');
    });
    
    // Ses dosyalarını tanımla
    const sounds = {
        connect: new Audio('/static/sounds/connect.mp3'),
        message: new Audio('/static/sounds/message.mp3'),
        disconnect: new Audio('/static/sounds/disconnect.mp3')
    };
    
    // Ses çalma fonksiyonu
    function playSound(soundName) {
        try {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(err => console.error('Ses çalma hatası:', err));
            }
        } catch (error) {
            console.error('Ses çalma hatası:', error);
        }
    }
    
    socket.on('disconnect', function() {
        console.log('Socket.io bağlantısı kesildi');
        playSound('disconnect');
    });

    // --- MODERN EMOJI PICKER ---
    document.querySelectorAll('.emoji-panel').forEach(panel => panel.style.display = 'none'); // Tüm panelleri başta kapalı yap

    document.querySelectorAll('.emoji-btn').forEach(function(btn) {
        const inputGroup = btn.closest('.input-group');
        const panel = inputGroup.querySelector('.emoji-panel');
        const input = inputGroup.querySelector('textarea, input');
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Emoji butonuna tıklandı!');
            // Diğer açık panelleri kapat
            document.querySelectorAll('.emoji-panel').forEach(p => { if (p !== panel) p.style.display = 'none'; });
            panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'grid' : 'none';
        });
        function handleEmojiSelect(e) {
            let emojiSpan = e.target;
            if (!emojiSpan.classList.contains('emoji')) {
                emojiSpan = emojiSpan.closest('.emoji');
            }
            if (emojiSpan && emojiSpan.classList.contains('emoji')) {
                if (input) {
                    input.value += emojiSpan.textContent;
                    input.focus();
                }
                panel.style.display = 'none';
            }
        }
        panel.addEventListener('click', handleEmojiSelect);
        panel.addEventListener('touchstart', handleEmojiSelect);
        document.addEventListener('click', function(e) {
            if (!panel.contains(e.target) && e.target !== btn) {
                panel.style.display = 'none';
            }
        });
    });

    if (typeof socket !== 'undefined') {
        socket.on('edit_dm', function(data) {
            // Mesajı bul ve güncelle
            const msgDiv = document.querySelector(`[data-message-id='${data.id}']`);
            if (msgDiv) {
                // Mesaj içeriğini ve etiketi güncelle
                const bubble = msgDiv.querySelector('.message-content');
                if (bubble) {
                    // Düzenlendi etiketi
                    const editedLabel = `<span class='badge bg-secondary text-light me-2' style='background:#e0e0e0;color:#888;font-size:0.85em;'>Düzenlendi</span>`;
                    
                    // Sticker etiketlerini kontrol et ve görsel olarak göster
                    let contentHtml = data.content;
                    const stickerMatch = contentHtml.match(/\[sticker\](.+?)\[\/sticker\]/g);
                    if (stickerMatch) {
                        // Tüm sticker etiketlerini görsellerle değiştir
                        stickerMatch.forEach(match => {
                            const stickerUrl = match.replace(/\[sticker\](.+?)\[\/sticker\]/, '$1');
                            contentHtml = contentHtml.replace(match, `<img src="${stickerUrl}" alt="sticker" style="max-width:120px;max-height:120px;border-radius:10px;">`);
                        });
                    }
                    
                    bubble.innerHTML = `${editedLabel}${contentHtml}`;
                }
                // 3 nokta menüsünü kaldır
                const menu = msgDiv.querySelector('.msg-menu');
                if (menu) menu.remove();
            }
        });
    }
});

function toggleSidebar() {
    const sidebar = document.getElementById('usersSidebar');
    sidebar.classList.toggle('open');
}

function closeSidebar() {
    const sidebar = document.getElementById('usersSidebar');
    sidebar.classList.remove('open');
}

function loadUsers() {
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            data.users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.onclick = () => selectUser(user.id, userItem);
                
                userItem.innerHTML = `
                    <img src="${user.profile_image}" alt="${user.username}" class="user-avatar">
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        <div class="user-role">${user.role}</div>
                        ${user.last_message ? `<div class="user-last-message">${user.last_message}</div>` : ''}
                    </div>
                    ${user.unread_count > 0 ? `<div class="unread-badge">${user.unread_count}</div>` : ''}
                `;
                
                usersList.appendChild(userItem);
            });
        })
        .catch(error => console.error('Kullanıcılar yüklenirken hata:', error));
}

function selectUser(userId, userItem) {
    currentChatUser = userId;
    
    // Aktif kullanıcıyı işaretle
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
    });
    userItem.classList.add('active');
    
    // Mobilde sidebar'ı kapat
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
    
    // Kullanıcı bilgilerini güncelle
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            const user = data.users.find(u => u.id === userId);
            if (user) {
                document.getElementById('chatUserAvatar').src = user.profile_image;
                document.getElementById('chatUserName').textContent = user.username;
                document.getElementById('chatUserRole').textContent = user.role;
            }
        });
    
    // Mesajları yükle
    loadMessages(userId);
    
    // Mesaj input'unu göster
    document.getElementById('messageInputContainer').style.display = 'block';
    document.getElementById('messageInput').focus();
}

function loadMessages(userId) {
    fetch(`/api/messages/${userId}`)
        .then(response => response.json())
        .then(data => {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            data.messages.forEach(message => {
                addMessageToChat(message);
            });
            
            // En alta kaydır
            messagesList.scrollTop = messagesList.scrollHeight;
        })
        .catch(error => console.error('Mesajlar yüklenirken hata:', error));
}

function addMessageToChat(message) {
    const messagesList = document.getElementById('messagesList');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_own ? 'own' : 'other'}`;
    messageDiv.setAttribute('data-message-id', message.id);
    let menuHtml = '';
    let editedLabel = '';
    if (message.edited || (message.edit_count && message.edit_count >= 1)) {
        editedLabel = `<span class='badge bg-secondary text-light me-2' style='background:#e0e0e0;color:#888;font-size:0.85em;'>Düzenlendi</span>`;
    }
    if (message.is_own) {
        menuHtml = `
        <div class='msg-menu' style='display:flex;align-items:center;min-width:32px;margin-left:8px;z-index:10;position:relative;'>
            <button class='msg-menu-btn' style='background:#c00;color:#fff;border:2px solid #000;border-radius:6px;padding:2px 10px;cursor:pointer;font-size:1.2em;'>▼</button>
            <div class='msg-menu-popup' style='display:none;position:absolute;top:32px;right:0;background:#fff;color:#222;border:1px solid #888;border-radius:8px;box-shadow:0 2px 8px #0002;min-width:120px;z-index:100;'>
                <a href='#' class='dropdown-item edit-msg-btn' data-id='${message.id}' data-content="${encodeURIComponent(message.content)}" style='color:#900;font-weight:bold;'>Düzenle</a>
            </div>
        </div>`;
    }
    // Satır: balon + 3 nokta menüsü
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.justifyContent = message.is_own ? 'flex-end' : 'flex-start';
    // Mesaj balonu
    const bubble = document.createElement('div');
    bubble.className = 'message-content';
    bubble.style.position = 'relative';
    bubble.style.display = 'inline-block';
    bubble.style.padding = '10px 16px';
    bubble.style.borderRadius = '16px';
    bubble.style.background = message.is_own ? '#900' : '#23272b';
    bubble.style.color = '#fff';
    bubble.style.maxWidth = '70vw';
    bubble.style.wordBreak = 'break-word';
    
    // Sticker etiketlerini kontrol et ve görsel olarak göster
    let contentHtml = message.content;
    const stickerMatch = contentHtml.match(/\[sticker\](.+?)\[\/sticker\]/g);
    if (stickerMatch) {
        // Tüm sticker etiketlerini görsellerle değiştir
        stickerMatch.forEach(match => {
            const stickerUrl = match.replace(/\[sticker\](.+?)\[\/sticker\]/, '$1');
            contentHtml = contentHtml.replace(match, `<img src="${stickerUrl}" alt="sticker" style="max-width:120px;max-height:120px;border-radius:10px;">`);
        });
    }
    
    bubble.innerHTML = `${editedLabel}${contentHtml}`;
    row.appendChild(bubble);
    if (menuHtml) {
        const menuDiv = document.createElement('div');
        menuDiv.innerHTML = menuHtml;
        // Menü butonuna tıklayınca popup aç/kapat
        setTimeout(() => {
            const btn = menuDiv.querySelector('.msg-menu-btn');
            const popup = menuDiv.querySelector('.msg-menu-popup');
            if (btn && popup) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
                });
                // Dışarı tıklanınca menüyü kapat
                document.addEventListener('click', function() {
                    popup.style.display = 'none';
                });
            }
        }, 0);
        row.appendChild(menuDiv.firstChild);
    }
    messageDiv.appendChild(row);
    messagesList.appendChild(messageDiv);
    messagesList.scrollTop = messagesList.scrollHeight;
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || !currentChatUser) return;
    
    // Input'u temizle ve gönder butonunu devre dışı bırak
    input.value = '';
    const sendBtn = document.getElementById('sendMessageBtn');
    sendBtn.disabled = true;
    
    // Sunucuya gönder
    fetch('/api/send_dm', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            receiver_id: currentChatUser,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        sendBtn.disabled = false;
        if (!data.success) {
            alert('Mesaj gönderilemedi: ' + data.error);
            // Hata durumunda mesajı geri koy
            input.value = content;
        }
    })
    .catch(error => {
        console.error('Mesaj gönderilirken hata:', error);
        alert('Mesaj gönderilirken bir hata oluştu');
        sendBtn.disabled = false;
        // Hata durumunda mesajı geri koy
        input.value = content;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    function fetchMyStickersModal() {
        fetch('/my_stickers').then(r=>r.json()).then(data => {
            const list = document.getElementById('my-sticker-modal-list');
            list.innerHTML = '';
            if(data.stickers.length === 0) {
                list.innerHTML = '<div style="color:#ccc">Hiç emoji/çıkartma eklemediniz.</div>';
                return;
            }
            data.stickers.forEach(sticker => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.style = 'background:none;border:none;padding:0;outline:none;cursor:pointer;';
                btn.innerHTML = `<img src="${sticker.file_url}" alt="${sticker.type}" style="width:56px;height:56px;border-radius:8px;background:#222;object-fit:contain;">`;
                btn.onclick = function() {
                    // Mesaj kutusuna ekle (gönderme!)
                    var input = document.getElementById('messageInput');
                    if(input) {
                        input.value = `[sticker]${sticker.file_url}[/sticker]`;
                        input.focus();
                    }
                    var modal = bootstrap.Modal.getInstance(document.getElementById('myStickerModal'));
                    if(modal) modal.hide();
                };
                list.appendChild(btn);
            });
        });
    }
    var stickerBtn = document.getElementById('my-sticker-btn');
    if(stickerBtn) {
        stickerBtn.addEventListener('click', function() {
            fetchMyStickersModal();
            var modal = new bootstrap.Modal(document.getElementById('myStickerModal'));
            modal.show();
        });
    }
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-msg-btn')) {
        const msgId = e.target.getAttribute('data-id');
        const content = decodeURIComponent(e.target.getAttribute('data-content'));
        document.getElementById('editMessageId').value = msgId;
        document.getElementById('editMessageInput').value = content;
        var modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
        modal.show();
    }
});
document.getElementById('saveEditBtn').addEventListener('click', function() {
    const msgId = document.getElementById('editMessageId').value;
    const newContent = document.getElementById('editMessageInput').value.trim();
    if (!msgId || !newContent) return;
    fetch('/api/edit_dm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message_id: msgId, content: newContent })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Mesajları yeniden yükle
            if (currentChatUser) loadMessages(currentChatUser);
            var modal = bootstrap.Modal.getInstance(document.getElementById('editMessageModal'));
            if(modal) modal.hide();
        } else {
            alert(data.error || 'Düzenleme başarısız');
        }
    });
});
</script>
{% endblock %}